# 🧠 ZIGGURAT MIND — Система памяти

## 📋 Обзор системы

Ziggurat Mind использует **гибридную систему памяти** с двумя уровнями:

```
┌─────────────────────────────────────────────────────────────┐
│                    ZIGGURAT MIND                            │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌─────────────────────────────────┐│
│  │   ПЕРСОНА       │    │          ПАМЯТЬ                  ││
│  │   (Persona)     │◄──►│          (Memory)                ││
│  └─────────────────┘    └─────────────────────────────────┘│
│         │                        │                          │
│         │                        ▼                          │
│         │              ┌─────────────────────────────┐     │
│         │              │     Контекст сессии          │     │
│         │              │   (Session Context)         │     │
│         │              └─────────────────────────────┘     │
│         │                        │                          │
│         ▼                        ▼                          │
│  ┌─────────────────────────────────────────────────────┐  │
│  │           ГИБРИДНАЯ ПАМЯТЬ (Hybrid Memory)          │  │
│  ├─────────────────────────────────────────────────────┤  │
│  │  ┌─────────────────┐    ┌─────────────────────────┐ │  │
│  │  │  ЭПИЗОДИЧЕСКАЯ  │    │    СЕМАНТИЧЕСКАЯ        │ │  │
│  │  │  (Episodic)     │    │    (Semantic)           │ │  │
│  │  │                 │    │                         │ │  │
│  │  │  • Диалоги      │    │  • Факты               │ │  │
│  │  │  • Контекст     │    │  • Предпочтения        │ │  │
│  │  │  • Сессии       │    │  • Правила             │ │  │
│  │  │  • Векторный    │    │  • Навыки              │ │  │
│  │  │    поиск        │    │  • Концепты            │ │  │
│  │  └─────────────────┘    └─────────────────────────┘ │  │
│  └─────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## 🗂️ Организация памяти

### 1. Эпизодическая память (Episodic Memory)

Хранит историю разговоров и контекст диалогов.

**Расположение:** `memory_data/episodic/`

**Файлы:**
- `sessions.json` — история сессий диалогов
- `embeddings.bin` — векторные представления диалогов

**Как работает:**
- Каждый обмен (prompt + response) сохраняется как "эпизод"
- При запросе о прошлом выполняется поиск похожих диалогов
- Результаты используются как контекст для генерации ответа

**Активация:**
```bash
--enable-memory
```

---

### 2. Семантическая память (Semantic Memory)

Хранит структурированные знания о пользователе.

**Расположение:** `memory_data/semantic/`

**Файл:** `semantic_memory.json`

**Категории концептов:**

| Категория | Описание | Пример |
|-----------|----------|--------|
| `facts` | Факты о пользователе | "Пользователь работает программистом" |
| `preferences` | Предпочтения | "Любит пиццу" |
| `rules` | Правила/ограничения | "Не любит ранние подъемы" |
| `skills` | Навыки пользователя | "Знает Python" |
| `general` | Общие знания | "Интересуется AI" |

**Как работает:**
- Извлекает факты из реплик пользователя
- Сохраняет с категорией и уровнем достоверности (confidence)
- При запросах ищет релевантные концепты
- Используется в системном промпте персоны

**Активация:**
```bash
--enable-semantic
```

---

### 3. Контекст сессии (Session Context)

Временная память о текущем разговоре.

**Расположение:** `memory_data/context/`

**Файл:** `{archetype}_context.json`

**Содержимое:**
- Резюме разговора
- Ключевые темы
- Эмоциональное состояние
- Неотвеченные вопросы
- Временные метки

**Автосохранение:**
- При выходе (`quit`)
- При `Ctrl+C`

---

## 🚀 Использование

### Базовый запуск с памятью

```bash
# Интерактивный режим с обоими типами памяти
cargo run --features cuda -- --interactive --archetype girlfriend --enable-memory --enable-semantic

# С семантической памятью
cargo run --features cuda -- --interactive --archetype girlfriend --enable-semantic

# Только с эпизодической памятью
cargo run --features cuda -- --interactive --archetype girlfriend --enable-memory

# Один запрос с памятью
cargo run --features cuda -- --prompt "помнишь о чем мы говорили?" --enable-memory --enable-semantic
```

### Параметры памяти

```bash
--memory-top-k 5        # Количество похожих диалогов для извлечения
--semantic-top-k 10     # Количество концептов для извлечения
--disable-memory-context  # Отключить контекст памяти (для отладки)
--quiet                 # Не показывать отладочную информацию
```

### Команды в интерактивном режиме

```
/semantic help         # Помощь по семантической памяти
/semantic list         # Показать концепты
/semantic stats        # Статистика памяти
/semantic search <запрос>  # Поиск по концептам
/context               # Показать контекст сессии
/persona               # Управление персоной
/mem                   # Использование памяти
quit                   # Выйти и сохранить
```

---

## 💾 Примеры работы

### Извлечение предпочтений

```text
📝 You: я люблю пиццу с ананасами
🤖 Алиса: Отлично, запомню! 🍕

# В памяти создается концепт:
# {"text": "Любит пиццу с ананасами", "category": "preferences", "confidence": 0.8}
```

### Поиск по памяти

```text
📝 You: а какую пиццу я люблю?
🤖 Алиса: Ты упоминал, что любишь пиццу с ананасами 🍍
```

### Запрос прошлого разговора

```text
📝 You: помнишь о чем мы говорили в прошлый раз?
# Система ищет в эпизодической памяти и возвращает контекст
```

---

## 🧹 Как очистить память

### Очистить всю память

```bash
# Удалить папку с памятью
rm -rf memory_data/

# Перезапустить — папка создастся автоматически
```

### Очистить только семантическую память

```bash
# Удалить файл семантической памяти
rm memory_data/semantic/semantic_memory.json

# Или в интерактивном режиме:
# /semantic delete <id>
```

### Очистить только эпизодическую память

```bash
# Удалить файлы эпизодической памяти
rm memory_data/episodic/sessions.json
rm memory_data/episodic/embeddings.bin
```

### Очистить контекст сессии

```bash
# Удалить файл контекста
rm memory_data/context/girlfriend_context.json
```

### Автоматический сброс (программно)

```bash
# Остановить приложение, удалить нужные файлы, перезапустить
```

---

## 📊 Структура файлов

```
memory_data/
├── context/                    # Контекст сессии
│   └── girlfriend_context.json
├── episodic/                   # Эпизодическая память
│   ├── sessions.json
│   └── embeddings.bin
└── semantic/                   # Семантическая память
    └── semantic_memory.json
```

---

## ⚠️ Важные ограничения

1. **Не придумывай** — Персона не должна выдумывать факты, которых не было
2. **Только явные утверждения** — Извлекаются только прямые высказывания ("я люблю...")
3. **Контекстная активация** — Память активируется только при явном запросе ("помнишь...")
4. **Проверка достоверности** — Концепты хранятся с уровнем confidence

---

## 🔧 Устранение неполадок

### Память не сохраняется

```bash
# Проверить права на запись
ls -la memory_data/

# Пересоздать структуру папок
mkdir -p memory_data/{context,episodic,semantic}
```

### Персона не помнит

1. Проверить что память активирована: `--enable-memory --enable-semantic`
2. Проверить что файл существует: `memory_data/semantic/semantic_memory.json`
3. Проверить что были явные высказывания (не вопросы)

### Галлюцинации

Если персона выдумывает факты:
- Убедитесь что используется последняя версия с анти-галлюцинационными инструкциями
- Очистите память и начните заново
- Используйте `--quiet` для отладки

---

## 📝 Формат файла семантической памяти

```json
{
  "version": "1.0",
  "created_at": "2026-01-21T...",
  "last_saved_at": "2026-01-21T...",
  "total_concepts": 5,
  "concepts": [
    {
      "id": "uuid-...",
      "text": "Любит пиццу с ананасами",
      "category": "preferences",
      "confidence": 0.8,
      "source": "girlfriend",
      "metadata": {},
      "created_at": "2026-01-21T...",
      "updated_at": "2026-01-21T...",
      "usage_count": 3
    }
  ]
}
```
